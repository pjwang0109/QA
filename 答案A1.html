// 資料包裝並上傳
let chan = new $.Deferred().resolve();
let allFileJson = []; // 用來收集所有 filejson 資料

for (let i = 0; i < fileLength; i++) {
    let fileData = new FormData();
    fileData.append("token", token);
    fileData.append("uid", uid);
    fileData.append("caseno", caseno);
    fileData.append("filetype", filetype);
    fileData.append("uploadfile", files[i]);

    let s140020009 = getS140020009(fileData, i, "loadingOpView");

    chan = chan.pipe(function () {
        return $.ajax(s140020009).pipe(
            // 成功處理
            function (filejson) {
                console.log(`Response from request ${i}:`, filejson);

                // 如果 filejson 是字串，嘗試解析
                if (typeof filejson === "string") {
                    try {
                        filejson = JSON.parse(filejson);
                    } catch (e) {
                        console.error("JSON 解析錯誤：", e);
                        return $.Deferred().resolve();
                    }
                }

                // 儲存 filejson
                allFileJson.push(filejson);

                // 更新畫面
                if (filejson.rc != "M0401") {
                    let $modal = $("#loadingOpView").find('tbody tr:nth(' + i + ')');
                    let $bar = $modal.find('.progress-bar');
                    let $percent = $modal.find('.percentVal');
                    let $msg = $modal.find('.msg');
                    $bar.width("0%");
                    $percent.html("0%");
                    $msg.addClass("text-danger").html("錯誤訊息：" + filejson.msg);
                } else {
                    let $modal = $("#loadingOpView").find('tbody tr:nth(' + i + ')');
                    let $msg = $modal.find('.msg');
                    $msg.addClass("text-success").html("夾檔成功");
                }

                return $.Deferred().resolve();
            },
            // 錯誤處理
            function (jqXHR, textStatus, errorThrown) {
                console.error(`Error in request ${i}:`, errorThrown);
                let $modal = $("#loadingOpView").find('tbody tr:nth(' + i + ')');
                let $bar = $modal.find('.progress-bar');
                let $percent = $modal.find('.percentVal');
                let $msg = $modal.find('.msg');
                $bar.width("0%");
                $percent.html("0%");
                $msg.addClass("text-danger").html("伺服器發生錯誤，上傳失敗：" + errorThrown);
                return $.Deferred().resolve();
            }
        );
    });
}

chan.pipe(function () {
    // 在這裡打印收集到的所有 filejson 資料
    console.log("所有的 filejson 資料：", allFileJson);

    // 清空輸入欄位並執行後續邏輯
    $file.val("").change();
    apiOpS000040010(uid, token, caseno, "").done(function (jsondata) {
        $('#msg_token').text(jsondata.token);
        if (jsondata.rc == "M0000") {
            console.log("更新清單完成", jsondata.result);
        } else {
            apiErrorHandler(jsondata);
        }
    });
    $modal.find("button").prop("disabled", false);
});