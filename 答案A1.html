set401PageDataCR

let mpritemArr = dataObj["401mpritem"] || [];
const $primaryProductDiv = $target.find(".primaryProductDiv");
const $addBtn = $primaryProductDiv.find(".product-add-btn");

mpritemArr = mpritemArr.sort((a, b) => Number(a.dataseq) - Number(b.dataseq));

if (mpritemArr.length > 0) {
  // 從每筆資料中找出所有年份 key，建立 yearList
  yearList = [];
  mpritemArr.forEach(item => {
    for (let i = 1; i <= 3; i++) {
      const year = parseInt(item[`yyy${i}`]);
      if (!isNaN(year) && !yearList.includes(year)) {
        yearList.push(year);
      }
    }
  });
  yearList.sort((a, b) => a - b);

  // 根據 yearList 建立欄位結構
  updateTableHeader($addBtn);
  updateProductRows($addBtn);

  // 填入資料
  for (const v of mpritemArr) {
    addPrimaryProductTableDataCR($addBtn, v);
  }
}



function addPrimaryProductTableDataCR($target, data) {
  const $cardBody = $target.closest('.card-body');
  const $tbody = $cardBody.find('#product-body');

  // 先新增一列產品資料列
  addProductTableData($target);

  const $lastRow = $tbody.find('.product-row:last');

  // 填入產品名稱
  $lastRow.find('textarea.pname').val(data["pname"]);

  // 填入每一年的佔營收比
  Object.keys(data).forEach(key => {
    const match = key.match(/^rratio(\d)$/);
    if (match) {
      const idx = parseInt(match[1], 10) - 1; // rratio1 對應 yearList[0]
      const year = yearList[idx];
      const $input = $lastRow.find(`.year-col-${year} .rate-input`);
      $input.val(data[key]);
    }
  });
}
