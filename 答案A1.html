function addYearDataUnit(obj) {
    const $input = $(obj).closest('.d-flex').find('.infoYearData');
    const year = parseInt($input.val());
    const maxYears = 3;
    const $cardBody = $(obj).closest('.card-body');

    let yearList = getYearList($cardBody);

    if (isNaN(year)) {
        alert('請輸入數字');
        $input.val("");
        return;
    }

    if (yearList.length >= maxYears) {
        alert('已達3個');
        return;
    }

    if (yearList.includes(year)) {
        alert('此年份已存在');
        return;
    }

    yearList.push(year);
    yearList.sort((a, b) => a - b);
    setYearList($cardBody, yearList);

    updateTableHeader($cardBody);
    updateProductRows($cardBody);

    $input.val(year + 1);
}

function deleteYearUnit(obj) {
    const $th = $(obj).closest('th');
    const year = parseInt($th.find('input.product-year').val());
    const $cardBody = $(obj).closest('.card-body');

    let yearList = getYearList($cardBody);
    yearList = yearList.filter(y => y !== year);
    yearList.sort((a, b) => a - b);
    setYearList($cardBody, yearList);

    $cardBody.find(`.year-col-${year}`).remove();

    $cardBody.find('.product-year').each(function (index) {
        const updateClass = $(this).attr('class').split(' ').filter(cls => !/^yy-\d+$/.test(cls)).join(' ');
        $(this).attr('class', updateClass + ` yy-${index + 1}`);
    });

    const columnCount = yearList.length;
    $cardBody.find('#product-body .product-row').each(function () {
        const $rateInputs = $(this).find('.rate-input');
        for (let colIndex = 0; colIndex < columnCount; colIndex++) {
            const $input = $rateInputs.eq(colIndex);
            if ($input.length) {
                const updatedClass = $input.attr('class').split(' ').filter(cls => !/^rate-\d+$/.test(cls)).join(' ');
                $input.attr('class', `${updatedClass} rate-${colIndex + 1}`);
            }
        }
    });
}


function set401PageDataCR($target, dataObj) {
    const mpritemArr = dataObj["401mpritem"] || [];
    const $productDiv = $target.find('#primaryProductDiv_401');

    if (mpritemArr.length > 0) {
        const yearSet = new Set();
        $.each(mpritemArr, function (_, item) {
            $.each(item.year_rate || {}, function (year, _) {
                yearSet.add(parseInt(year));
            });
        });

        const yearList = Array.from(yearSet).sort((a, b) => a - b);
        setYearList($productDiv, yearList);

        updateTableHeader($productDiv);
    }

    $.each(mpritemArr, function (_, v) {
        addPrimaryProductTableDataCR($productDiv, v);
    });
}



function addPrimaryProductTableDataCR($container, item) {
    const yearList = getYearList($container);
    const $row = $('<tr class="product-row"></tr>');

    $row.append(`
        <td class="d-flex">
            <button class="btn btn-danger mr-2 del-pro-btn" onclick="deleteProductsUnit(this)">
                <i class="fa fa-times"></i>
            </button>
            <textarea class="form-control pname" rows="1">${item.name || ''}</textarea>
        </td>
        <td style="vertical-align:middle" class="text-center">佔營收比</td>
    `);

    $.each(yearList, function (i, year) {
        const rate = item.year_rate?.[year] || '';
        const rateN = i + 1;

        const $td = $(`
            <td class="year-col year-col-${year}">
                <div class="form-inline rate-${year}">
                    <input type="text" maxlength="3" style="width: 114px" 
                           class="form-control rate-input rate-${rateN}" value="${rate}" />
                    <span class="input-group-text">%</span>
                </div>
            </td>
        `);

        insertSortedColumn($row, $td, year);
    });

    $container.find('#product-body').append($row);
}



function insertSortedColumn($parentRow, $newColumn, year) {
    let inserted = false;

    $parentRow.children('td.year-col').each(function () {
        const currentYear = parseInt($(this).attr('class').match(/year-col-(\d+)/)?.[1]);
        if (!isNaN(currentYear) && year < currentYear) {
            $(this).before($newColumn);
            inserted = true;
            return false;
        }
    });

    if (!inserted) {
        $parentRow.append($newColumn);
    }
}
