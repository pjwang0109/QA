<div class="container">
  <h3>產品資訊表格</h3>
  <button id="add-year-btn" class="btn btn-primary">新增年度欄位</button>
  <button id="add-product-btn" class="btn btn-success">新增產品</button>
  <table class="table table-bordered">
    <thead>
      <tr class="header-row">
        <th style="width: 20%">產品名稱</th>
        <!-- 年度標題欄位插入位置 -->
      </tr>
    </thead>
    <tbody id="product-body">
      <!-- 產品資料列插入位置 -->
    </tbody>
  </table>
</div>

<script>
  let maxYearCols = 5;
  let currentYear = 2024;
  let yearList = []; // 紀錄目前有哪些年份
  let productIndex = 0;

  // 新增年度欄位
  $('#add-year-btn').on('click', function () {
    if (yearList.length >= maxYearCols) {
      alert("最多只能新增 " + maxYearCols + " 個年度欄位");
      return;
    }

    const year = currentYear++;
    yearList.push(year);

    // 標題列新增 th
    $('.header-row').append(`
      <th class="year-${year}">
        ${year}
        <button class="btn btn-xs btn-danger" onclick="removeYear(${year})">
          <i class="glyphicon glyphicon-remove"></i>
        </button>
      </th>
    `);

    // 每筆產品都新增金額和比率欄位
    $('.product-row').each(function () {
      $(this).find('.amount-row').append(`<td class="year-${year}"><input type="text" class="form-control" /></td>`);
      $(this).find('.rate-row').append(`<td class="year-${year}"><input type="text" class="form-control" />%</td>`);
    });
  });

  // 移除某個年度欄位
  function removeYear(year) {
    $(`.year-${year}`).remove();
    yearList = yearList.filter(y => y !== year);
  }

  // 新增產品資料列
  $('#add-product-btn').on('click', function () {
    productIndex++;
    let newProduct = $(`
      <tr class="product-row" data-index="${productIndex}">
        <td rowspan="2">
          <textarea class="form-control pname" rows="1"></textarea>
        </td>
        <!-- 金額列 -->
        ${yearList.map(y => `<td class="year-${y}"><input type="text" class="form-control" /></td>`).join('')}
      </tr>
      <tr class="product-row" data-index="${productIndex}">
        <!-- 佔營收比列 -->
        <td>佔營收比</td>
        ${yearList.map(y => `<td class="year-${y}"><input type="text" class="form-control" />%</td>`).join('')}
      </tr>
    `);
    $('#product-body').append(newProduct);
  });
</script>
